const http = require('http');
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const url = require('url');
const crypto = require('crypto');

const PORT = 3001; // use different port to avoid conflicts
const SESSION_TIMEOUT = 3600 * 1000 * 24;
const BASE_DIR = __dirname;
const DB_FILE = path.join(BASE_DIR, 'articles.db');
const GENERATE_SCRIPT = path.join(BASE_DIR, 'generate_from_db.js');
const TEMP_SQL_FILE = path.join(BASE_DIR, 'temp_op.sql');

const sessions = {};
const MIME_TYPES = { '.html':'text/html', '.css':'text/css', '.js':'text/javascript', '.png':'image/png', '.jpg':'image/jpeg' };

function escapeSql(s){ if (!s) return "''"; return "'"+s.replace(/'/g,"''")+"'"; }
function getBody(req){ return new Promise((res,rej)=>{ let b=''; req.on('data',c=>b+=c); req.on('end',()=>res(new URLSearchParams(b))); req.on('error',rej); }); }
function getSession(req){ const c=req.headers.cookie; if(!c) return null; const m=c.match(/sessionId=([a-zA-Z0-9]+)/); if(!m) return null; const id=m[1]; if(sessions[id] && sessions[id].expires>Date.now()) return sessions[id]; delete sessions[id]; return null; }
function setSession(res,username){ const id=crypto.randomBytes(16).toString('hex'); sessions[id]={username,expires:Date.now()+SESSION_TIMEOUT}; res.setHeader('Set-Cookie', `sessionId=${id}; HttpOnly; Path=/; Max-Age=86400`); }
function renderPage(title,body){ return `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title></head><body style="font-family: -apple-system, sans-serif;background:#f7f3ef;padding:20px"><div style="max-width:1000px;margin:0 auto;background:#fff;padding:20px;border-radius:6px">${body}</div></body></html>`; }
function serveStatic(res, p){ if(fs.existsSync(p) && fs.statSync(p).isFile()){ const ext=path.extname(p); res.writeHead(200,{'Content-Type':MIME_TYPES[ext]||'application/octet-stream'}); res.end(fs.readFileSync(p)); return true; } return false; }

const server = http.createServer(async (req,res)=>{
  const parsed=url.parse(req.url,true); const pathname=parsed.pathname; const method=req.method; const session=getSession(req);

  if (pathname==='/'||pathname==='/index.html'){ if(serveStatic(res,path.join(BASE_DIR,'index.html'))) return; }
  if (pathname.startsWith('/articles/')||pathname.match(/\.(png|jpg|css|js|mp3)$/)) { if(serveStatic(res,path.join(BASE_DIR,pathname))) return; }

  if (pathname==='/media-list'){ if(!session){res.writeHead(403);res.end('Forbidden');return;} const root=path.join(BASE_DIR,'articles','facebook_media'); const out=[]; function w(d){ if(!fs.existsSync(d)) return; for(const it of fs.readdirSync(d,{withFileTypes:true})){ const p=path.join(d,it.name); if(it.isDirectory()) w(p); else { const rel=path.relative(BASE_DIR,p).split(path.sep).join('/'); if(rel.match(/\.(png|jpg|jpeg|gif|mp4)$/i)) out.push('/'+rel); } } } w(root); res.writeHead(200,{'Content-Type':'application/json'}); res.end(JSON.stringify(out)); return; }

  if (pathname==='/login'){ if(method==='GET'){ res.end(renderPage('登录',`<h1>登录</h1><form method="POST"><input name="username" required placeholder="用户名"><input name="password" type="password" required placeholder="密码"><button>登录</button></form>`)); return; } const params=await getBody(req); const username=params.get('username'); try{ const q=`SELECT * FROM users WHERE username=${escapeSql(username)}`; const out=execSync(`sqlite3 -json "${DB_FILE}" "${q}"`).toString(); const rows=JSON.parse(out||'[]'); if(rows.length){ setSession(res,username); res.writeHead(302,{'Location':'/admin'}); res.end(); return; } res.writeHead(302,{'Location':'/register'}); res.end(); return; }catch(e){ res.end('Error:'+e.message); return; } }

  if (pathname==='/register'){ if(method==='GET'){ res.end(renderPage('注册',`<h1>注册</h1><form method="POST"><input name="username" required placeholder="用户名"><input name="password" type="password" required placeholder="密码"><button>注册</button></form>`)); return; } const params=await getBody(req); const username=params.get('username'); const password=params.get('password'); if(!username||!password){ res.end('bad'); return; } try{ const salt=crypto.randomBytes(16).toString('hex'); const hash=crypto.pbkdf2Sync(password,salt,1000,64,'sha512').toString('hex'); const sql=`INSERT INTO users (username,password,salt) VALUES (${escapeSql(username)},'${hash}','${salt}')`; fs.writeFileSync(TEMP_SQL_FILE,sql); execSync(`sqlite3 "${DB_FILE}" < "${TEMP_SQL_FILE}"`); fs.unlinkSync(TEMP_SQL_FILE); res.writeHead(302,{'Location':'/login'}); res.end(); return; }catch(e){ res.end('Error:'+e.message); return; } }

  if (pathname==='/admin'){ if(!session){ res.writeHead(302,{'Location':'/login'}); res.end(); return;} let arts=[]; try{ const q=`SELECT id,title,pub_date FROM articles ORDER BY pub_date DESC LIMIT 50`; const out=execSync(`sqlite3 -json "${DB_FILE}" "${q}"`).toString(); arts=JSON.parse(out||'[]'); }catch(e){} const rows=arts.map(a=>`<tr><td>${new Date(a.pub_date).toISOString().split('T')[0]}</td><td>${a.title}</td><td><a href="/edit?id=${a.id}">编辑</a></td></tr>`).join(''); res.end(renderPage('后台',`<h1>管理</h1><p>Hi ${session.username}</p><div><h3>发布新文章</h3><form method="POST" action="/publish"><input name="title" required placeholder="标题"><input name="pub_date" type="date" value="${new Date().toISOString().split('T')[0]}"><textarea name="content" style="height:120px"></textarea><button>发布</button></form></div><hr><table>${rows}</table>`)); return; }

  if (pathname==='/edit'){ if(!session){ res.writeHead(302,{'Location':'/login'}); res.end(); return; } const id=parsed.query.id; if(!id){ res.end('no id'); return;} let art=null; try{ const q=`SELECT * FROM articles WHERE id=${parseInt(id)}`; const out=execSync(`sqlite3 -json "${DB_FILE}" "${q}"`).toString(); const r=JSON.parse(out||'[]'); if(r.length) art=r[0]; }catch(e){} if(!art){ res.end('not found'); return; } let editable=art.content||''; const marker='<div class="article-content">'; if(editable.indexOf(marker)!==-1){ const s=editable.indexOf(marker)+marker.length; const e=editable.indexOf('</div>',s); if(e> s) editable=editable.substring(s,e); } const body=`<h1>编辑</h1><form method="POST" action="/update" onsubmit="return saveEditor(event)"><input type="hidden" name="id" value="${art.id}"><input name="title" value="${art.title}"><input name="pub_date" type="date" value="${new Date(art.pub_date).toISOString().split('T')[0]}"><textarea id="content-editor" name="content" style="display:none">${editable}</textarea><div id="block-editor" style="min-height:240px;border:1px solid #ddd;padding:8px"></div><div style="margin-top:8px"><button type="submit">保存</button> <button type="button" id="open-media">媒体库</button></div></form><div id="media-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center"><div style="background:#fff;max-width:900px;width:90%;max-height:80vh;overflow:auto;padding:12px;border-radius:6px"><div style="display:flex;justify-content:space-between"><strong>媒体库</strong><button id="close-media">关闭</button></div><div id="media-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;margin-top:8px"></div></div></div><script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script><script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.8.0"></script><script src="https://cdn.jsdelivr.net/npm/@editorjs/list@1.4.0"></script><script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@2.1.0"></script><script>var ed=new EditorJS({holder:'block-editor',tools:{header:Header,list:List,raw:RawTool},data:{blocks:[{type:'paragraph',data:{text:(document.getElementById('content-editor').value||'')}}]}});function blocksToHtml(b){var o='';(b||[]).forEach(function(x){if(x.type==='paragraph')o+='<p>'+ (x.data.text||'') +'</p>';else if(x.type==='header'){var l=(x.data.level||2);o+='<h'+l+'>'+ (x.data.text||'') +'</h'+l+'>';}else if(x.type==='raw')o+=(x.data.html||'');else o+='<pre>'+JSON.stringify(x)+'</pre>';});return o;}function saveEditor(e){if(e&&e.preventDefault)e.preventDefault();ed.save().then(function(d){document.getElementById('content-editor').value=blocksToHtml(d.blocks||[]);document.forms[0].submit();}).catch(function(err){alert('保存失败:'+err);});return false;}document.getElementById('open-media').addEventListener('click',function(){fetch('/media-list').then(r=>r.json()).then(list=>{var g=document.getElementById('media-grid');g.innerHTML='';list.forEach(function(u){var box=document.createElement('div');box.style.border='1px solid #eee';box.style.padding='6px';box.style.cursor='pointer';var img=document.createElement('img');img.src=u;img.style.width='100%';img.style.height='90px';img.style.objectFit='cover';box.appendChild(img);box.addEventListener('click',function(){ed.blocks.insert('raw',{html:'<p><img src="'+u+'"/></p>'},{},undefined);document.getElementById('media-modal').style.display='none';});g.appendChild(box);});document.getElementById('media-modal').style.display='flex';});});document.getElementById('close-media').addEventListener('click',function(){document.getElementById('media-modal').style.display='none';});</script>`; res.end(renderPage('编辑',body)); return; }

  if (pathname==='/update' && method==='POST'){ if(!getSession(req)){res.end('Unauthorized');return;} const params=await getBody(req); const id=params.get('id'); const title=params.get('title'); const pub_date=params.get('pub_date'); const content=params.get('content'); try{ const full=new Date(pub_date).toISOString(); const slug=generateSlug(pub_date,title); const excerpt=getExcerpt(content); const sql=`UPDATE articles SET title=${escapeSql(title)},content=${escapeSql(content)},pub_date=${escapeSql(full)},slug=${escapeSql(slug)},excerpt=${escapeSql(excerpt)} WHERE id=${parseInt(id)};`; fs.writeFileSync(TEMP_SQL_FILE,sql); execSync(`sqlite3 "${DB_FILE}" < "${TEMP_SQL_FILE}"`); fs.unlinkSync(TEMP_SQL_FILE); execSync(`node "${GENERATE_SCRIPT}"`); res.writeHead(302,{'Location':'/admin'}); res.end(); }catch(e){ res.end('Error:'+e.message);} return; }

  if (pathname==='/publish' && method==='POST'){ if(!getSession(req)){res.end('Unauthorized');return;} const params=await getBody(req); const title=params.get('title'); const pub_date=params.get('pub_date'); const content=params.get('content'); try{ const full=new Date(pub_date).toISOString(); const slug=generateSlug(pub_date,title); const excerpt=getExcerpt(content); const sql=`INSERT INTO articles (title,content,pub_date,slug,excerpt) VALUES (${escapeSql(title)},${escapeSql(content)},${escapeSql(full)},${escapeSql(slug)},${escapeSql(excerpt)});`; fs.writeFileSync(TEMP_SQL_FILE,sql); execSync(`sqlite3 "${DB_FILE}" < "${TEMP_SQL_FILE}"`); fs.unlinkSync(TEMP_SQL_FILE); execSync(`node "${GENERATE_SCRIPT}"`); res.writeHead(302,{'Location':'/admin'}); res.end(); }catch(e){ res.end('Error:'+e.message);} return; }

  if (pathname==='/delete'){ if(!getSession(req)){ res.writeHead(302,{'Location':'/login'}); res.end(); return;} const id=parsed.query.id; if(id){ try{ const sql=`DELETE FROM articles WHERE id=${parseInt(id)};`; fs.writeFileSync(TEMP_SQL_FILE,sql); execSync(`sqlite3 "${DB_FILE}" < "${TEMP_SQL_FILE}"`); fs.unlinkSync(TEMP_SQL_FILE); execSync(`node "${GENERATE_SCRIPT}"`); res.writeHead(302,{'Location':'/admin'}); res.end(); return; }catch(e){ res.end('Error:'+e.message);} } }

  res.writeHead(404); res.end('Not Found');
});

server.listen(PORT,()=>console.log(`Admin fixed server running: http://localhost:${PORT}`));